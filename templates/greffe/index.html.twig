{# minimal template qui utilise base.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Recherche Greffe{% endblock %}

{% block body %}
<div class="card shadow-sm">
  <div class="card-body">
    <h5 class="card-title mb-3">Recherche de patients</h5>

    <form id="greffeForm" class="row g-2 align-items-end">
      <div class="col-md-5">
        <label class="form-label visually-hidden" for="q">Nom ou prénom</label>
        <input id="q" name="q" type="search" class="form-control" placeholder="Nom ou prénom">
      </div>

      <div class="col-md-2">
        <label class="form-label visually-hidden" for="status">Statut</label>
        <select id="status" name="status" class="form-select">
          <option value="">Tous</option>
          <option value="need">Besoin de greffe</option>
          <option value="had">A subi une greffe</option>
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label visually-hidden" for="organ">Organe</label>
        <input id="organ" name="organ" type="text" class="form-control" placeholder="Organe (optionnel)">
      </div>

      <div class="col-md-2 d-grid">
        <button id="searchBtn" type="button" class="btn btn-primary">Rechercher</button>
      </div>

      <div class="col-6 col-md-3">
        <label class="form-label" for="date_from">Date from</label>
        <input id="date_from" name="date_from" type="date" class="form-control">
      </div>

      <div class="col-6 col-md-3">
        <label class="form-label" for="date_to">Date to</label>
        <input id="date_to" name="date_to" type="date" class="form-control">
      </div>
    </form>
  </div>
</div>

<div id="results" class="mt-4"></div>

{% block scripts %}
{{ parent() }}
<script>
(function(){
  const api = '{{ path('app_greffe_search') }}';
  const searchBtn = document.getElementById('searchBtn');
  const resultsEl = document.getElementById('results');

  function renderEmpty(text){ resultsEl.innerHTML = '<div class="alert alert-secondary">'+text+'</div>'; }
  function renderError(text){ resultsEl.innerHTML = '<div class="alert alert-danger">'+text+'</div>'; }

  function renderCards(items){
    if(!Array.isArray(items) || items.length===0){ renderEmpty('Aucun résultat.'); return; }
    const row = document.createElement('div');
    row.className = 'row g-3';
    items.forEach(p=>{
      const col = document.createElement('div');
      col.className = 'col-md-4';
      const card = document.createElement('div');
      card.className = 'card h-100';
      card.innerHTML = `
        <div class="card-body d-flex flex-column">
          <h6 class="card-title mb-1">${(p.nom||'')}${p.prenom? ' ' + p.prenom : ''}</h6>
          <p class="text-muted small mb-2">ID: ${p.id||''}${p.date_naissance? ' — Né(e): '+p.date_naissance : ''}</p>
          <div class="mt-auto">
            ${p.greffe ? '<span class="badge bg-success">Greffe: '+(p.greffe.organ||'')+'</span> <small class="text-muted ms-2">'+(p.greffe.date||'')+'</small>' : '<span class="badge bg-secondary">Pas de greffe</span>'}
          </div>
        </div>
      `;
      col.appendChild(card);
      row.appendChild(col);
    });
    resultsEl.innerHTML = '';
    resultsEl.appendChild(row);
  }

  function doSearch(){
    const params = new URLSearchParams();
    const q = document.getElementById('q').value.trim();
    const status = document.getElementById('status').value;
    const organ = document.getElementById('organ').value.trim();
    const dateFrom = document.getElementById('date_from').value;
    const dateTo = document.getElementById('date_to').value;
    if(q) params.set('q', q);
    if(status) params.set('status', status);
    if(organ) params.set('organ', organ);
    if(dateFrom) params.set('date_from', dateFrom);
    if(dateTo) params.set('date_to', dateTo);

    resultsEl.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

    fetch(api + '?' + params.toString(), { headers: { 'Accept': 'application/json' } })
      .then(r => {
        if(!r.ok) throw new Error('Network error');
        return r.json();
      })
      .then(renderCards)
      .catch(e => { console.error(e); renderError('Erreur lors de la recherche.'); });
  }

  searchBtn.addEventListener('click', doSearch);
  document.getElementById('q').addEventListener('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); doSearch(); }});
})();
</script>
{% endblock %}
{% endblock %}