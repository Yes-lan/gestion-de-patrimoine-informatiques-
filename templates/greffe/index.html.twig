{# minimal template qui utilise base.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Recherche Greffe{% endblock %}

{% block body %}
<section class="greffe-search">
  <header class="greffe-header">
    <h1>Recherche de patients — Greffe</h1>
    <p class="subtitle">Filtrer rapidement les patients ayant besoin d'une greffe ou ayant déjà subi une greffe.</p>
  </header>

  <div class="controls">
    <div class="radio-group" role="radiogroup" aria-label="Filtre greffe">
      <label class="radio-item">
        <input type="radio" name="status" value="" checked>
        <span>Tous</span>
      </label>
      <label class="radio-item">
        <input type="radio" name="status" value="need">
        <span>Besoin de greffe</span>
      </label>
      <label class="radio-item">
        <input type="radio" name="status" value="had">
        <span>A subi une greffe</span>
      </label>
    </div>

    <button id="searchBtn" class="btn-primary">Rechercher</button>
  </div>

  <div id="results" class="results">
    <div class="empty">Aucune recherche encore effectuée.</div>
  </div>
</section>

<script>
document.getElementById('searchBtn').addEventListener('click', function () {
  const status = document.querySelector('input[name="status"]:checked').value;
  const url = new URL('{{ path('app_greffe_search') }}', window.location.origin);
  if (status) url.searchParams.set('status', status);

  const resultsEl = document.getElementById('results');
  resultsEl.innerHTML = '<div class="loading">Chargement…</div>';

  fetch(url.toString(), { headers: { 'Accept': 'application/json' } })
    .then(r => r.json())
    .then(data => {
      if (!Array.isArray(data) || data.length === 0) {
        resultsEl.innerHTML = '<div class="empty">Aucun résultat.</div>';
        return;
      }
      const list = document.createElement('div');
      list.className = 'cards';
      data.forEach(p => {
        const card = document.createElement('article');
        card.className = 'card';
        card.innerHTML = `
          <div class="card-main">
            <div class="card-title">${(p.nom||'')}, ${(p.prenom||'')}</div>
            <div class="muted">ID: ${p.id||''} — ${p.date_naissance || ''}</div>
          </div>
          <div class="card-meta">
            ${p.greffe ? '<div class="badge badge-success">Greffe: ' + (p.greffe.organ||'') + ' — ' + (p.greffe.date||'') + '</div>' : '<div class="badge">Pas de greffe</div>'}
          </div>
        `;
        list.appendChild(card);
      });
      resultsEl.innerHTML = '';
      resultsEl.appendChild(list);
    })
    .catch(err => {
      console.error(err);
      resultsEl.innerHTML = '<div class="error">Erreur lors de la recherche.</div>';
    });
});
</script>
{% endblock %}